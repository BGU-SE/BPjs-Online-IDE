<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BProgramJsProxy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bp-ide-bpjs-bp-framework</a> &gt; <a href="index.source.html" class="el_package">il.ac.bgu.cs.bp.bpjs.execution.jsproxy</a> &gt; <span class="el_source">BProgramJsProxy.java</span></div><h1>BProgramJsProxy.java</h1><pre class="source lang-java linenums">package il.ac.bgu.cs.bp.bpjs.execution.jsproxy;

import il.ac.bgu.cs.bp.bpjs.model.BProgram;
import il.ac.bgu.cs.bp.bpjs.model.BThreadSyncSnapshot;
import il.ac.bgu.cs.bp.bpjs.model.BEvent;
import il.ac.bgu.cs.bp.bpjs.model.eventsets.EventSet;
import il.ac.bgu.cs.bp.bpjs.model.eventsets.EventSets;
import il.ac.bgu.cs.bp.bpjs.model.eventsets.JsEventSet;
import il.ac.bgu.cs.bp.bpjs.exceptions.BPjsRuntimeException;
import il.ac.bgu.cs.bp.bpjs.execution.tasks.FailedAssertionException;
import il.ac.bgu.cs.bp.bpjs.model.SyncStatement;
import il.ac.bgu.cs.bp.bpjs.model.ForkStatement;
import il.ac.bgu.cs.bp.bpjs.model.eventsets.ComposableEventSet;
import java.util.Map;
import java.util.Objects;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.logging.Level;
import java.util.logging.Logger;
import static java.util.stream.Collectors.toList;
import static java.util.stream.Collectors.toSet;
import java.util.stream.Stream;
import org.mozilla.javascript.Context;
import org.mozilla.javascript.ContinuationPending;
import org.mozilla.javascript.Function;
import org.mozilla.javascript.NativeArray;
import org.mozilla.javascript.NativeObject;

/**
 * An object representing the {@link BProgram} context for JavaScript code.
 * Methods in this object allow JavaScript code to register new BThreads, 
 * create events,write messages to the log etc.
 * 
 * Methods in the class are available to JavaScript code via the {@code bp}
 * object, like so:
 * 
 * &lt;pre&gt;&lt;code&gt;
 * bp.log.info(&quot;I'm a log message!&quot;);
 * var myEvent = bp.Event(&quot;My Event&quot;);
 * bp.registerBThread(...);
 * &lt;/code&gt;&lt;/pre&gt;
 * 
 * @author michael
 */
public class BProgramJsProxy extends SyncStatementBuilder
                             implements java.io.Serializable {
    
<span class="fc" id="L47">    private static final ThreadLocal&lt;BThreadSyncSnapshot&gt; CURRENT_BTHREAD = new ThreadLocal&lt;&gt;();</span>
    
    
    public static void setCurrentBThread( BThreadSyncSnapshot bss ) {
<span class="fc" id="L51">        CURRENT_BTHREAD.set(bss);</span>
<span class="fc" id="L52">    }</span>
    
    public static void clearCurrentBThread(){
<span class="fc" id="L55">        CURRENT_BTHREAD.remove();</span>
<span class="fc" id="L56">    }</span>
    
    private final BProgram program;
    
<span class="fc" id="L60">    private final AtomicInteger autoAddCounter = new AtomicInteger(0);</span>
    
<span class="fc" id="L62">    public final BpLog log = new BpLog();</span>
    
<span class="fc" id="L64">    public final EventSet all = EventSets.all;</span>
    
<span class="fc" id="L66">    public final EventSet none = EventSets.none;</span>
    
    /**
     * Facility for creating random numbers. BPjs code should not use JavaScript's
     * random facility, as it won't play well with model checking.
     */
<span class="fc" id="L72">    public RandomProxy random = new RandomProxy();</span>
    
<span class="fc" id="L74">    public BProgramJsProxy(BProgram program) {</span>
<span class="fc" id="L75">        this.program = program;</span>
<span class="fc" id="L76">    }</span>
    
    /**
     * Event constructor, called from JavaScript, hence the funny
     * capitalization.
     *
     * @param name name of the event
     * @return an event with the passed name.
     */
    public BEvent Event(String name) {
<span class="fc" id="L86">        return new BEvent(name);</span>
    }

    /**
     * Event constructor, called from JavaScript, hence the funny
     * capitalization.
     *
     * @param name name of the event
     * @param jsData Additional data for the object.
     * @return an event with the passed name.
     */
    public BEvent Event(String name, Object jsData) {
<span class="fc" id="L98">        return new BEvent(name, jsData );</span>
    }
    
    public JsEventSet EventSet(String name, Object predicateObj) {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        if ( predicateObj instanceof Function ) {</span>
<span class="fc" id="L103">            return new JsEventSet(name, (Function) predicateObj);</span>
        } else {
<span class="nc" id="L105">            throw new BPjsRuntimeException(&quot;An event set predicate has to be a function.&quot;);</span>
        }
    }
    
    public EventSet allExcept( EventSet es ) {
<span class="nc" id="L110">        return ComposableEventSet.not(es);</span>
    }
    
    /**
     * Called from JS to add BThreads with data.
     *
     * @param name Name of the registered BThread (useful for debugging).
     * @param data Data object for the b-thread.
     * @param func Script entry point of the BThread.
     *
     * @see #registerBThread(org.mozilla.javascript.Function)
     */
    public void registerBThread(String name, Object data, Function func) {
<span class="nc" id="L123">        program.registerBThread(new BThreadSyncSnapshot(name, func, null, null, null, data));</span>
<span class="nc" id="L124">    }</span>
    
    /**
     * Called from JS to add BThreads running function as their runnable code.
     *
     * @param name Name of the registered BThread (useful for debugging).
     * @param func Script entry point of the BThread.
     *
     * @see #registerBThread(org.mozilla.javascript.Function)
     */
    public void registerBThread(String name, Function func) {
<span class="fc" id="L135">        program.registerBThread(new BThreadSyncSnapshot(name, func));</span>
<span class="fc" id="L136">    }</span>

    /**
     * Registers a BThread and gives it a unique name. Use when you don't care
     * about the added BThread's name.
     *
     * @param func the BThread to add.
     *
     * @see #registerBThread(java.lang.String, org.mozilla.javascript.Function)
     */
    public void registerBThread(Function func) {
<span class="fc" id="L147">        registerBThread(&quot;autoadded-&quot; + autoAddCounter.incrementAndGet(), func);</span>
<span class="fc" id="L148">    }</span>
    
    /**
     * If {@code value} is {@code false}, puts the entire program in an invalid
     * state. This, in turn, would terminate it when it's being run, or discover 
     * a specification violation when it's being verified.
     * 
     * note: I'd rather call it {@code assert} too, but that's a Java keyword, which complicates stuff.
     * 
     * @param value The value of the assertion. When {@code false}, the program is declared in invalid state.
     * @param message Textual information about what caused the violation.
     * @throws FailedAssertionException if {@code value} is false.
     */
    public void ASSERT( boolean value, String message ) throws FailedAssertionException {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if ( ! value ) {</span>
<span class="fc" id="L163">            throw new FailedAssertionException( message );</span>
        }
<span class="nc" id="L165">    }</span>
    
    
    public void fork() throws ContinuationPending {
<span class="nc" id="L169">        ContinuationPending capturedContinuation = Context.getCurrentContext().captureContinuation();</span>
<span class="nc" id="L170">        capturedContinuation.setApplicationState(new ForkStatement(capturedContinuation.getContinuation()));</span>
<span class="nc" id="L171">        throw capturedContinuation;</span>
    }
    
    
    public void setInterruptHandler( Object aPossibleHandler ) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        CURRENT_BTHREAD.get().setInterruptHandler(</span>
                (aPossibleHandler instanceof Function) ? (Function) aPossibleHandler: null );
<span class="nc" id="L178">    }</span>
    
    ////////////////////////
    // sync (&quot;bp.sync&quot;) related code
    
    @Override
    public void sync( NativeObject jsRWB, Object data ) {
<span class="nc" id="L185">        synchronizationPoint(jsRWB, null, data);</span>
<span class="nc" id="L186">    }</span>
    
    @Override
    public SyncStatementBuilder hot(boolean isHot) {
<span class="fc" id="L190">        SyncStatementBuilderImpl sub = new SyncStatementBuilderImpl(this);</span>
<span class="fc" id="L191">        sub.setHotness(isHot);</span>
        
<span class="fc" id="L193">        return sub;</span>
    }
    
    /**
     * Where the actual Behavioral Programming synchronization point is done.
     * 
     * @param jsRWB The JavaScript object {@code {request:... waitFor:...}} 
     * @param hot   {@code True} if this should be a &quot;hot&quot; synchronization point.
     * @param data Optional extra data the synchronizing b-thread may want to add.
     */
    @Override
    void synchronizationPoint( NativeObject jsRWB, Boolean hot, Object data ) {
<span class="fc" id="L205">        Map&lt;String, Object&gt; jRWB = (Map)Context.jsToJava(jsRWB, Map.class);</span>
        
<span class="fc" id="L207">        SyncStatement stmt = SyncStatement.make();</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        if ( hot != null ) {</span>
<span class="fc" id="L209">            stmt = stmt.hot(hot);</span>
        }
<span class="fc" id="L211">        Object req = jRWB.get(&quot;request&quot;);</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">        if ( req != null ) {</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">            if ( req instanceof BEvent ) {</span>
<span class="fc" id="L214">                stmt = stmt.request((BEvent)req);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            } else if ( req instanceof NativeArray ) {</span>
<span class="nc" id="L216">                NativeArray arr = (NativeArray) req;</span>
<span class="nc" id="L217">                stmt = stmt.request(arr.getIndexIds().stream()</span>
<span class="nc" id="L218">                                       .map( i -&gt; (BEvent)arr.get(i) )</span>
<span class="nc" id="L219">                                       .collect( toList() ));</span>
            } 
        }

<span class="fc" id="L223">        EventSet waitForSet = convertToEventSet(jRWB.get(&quot;waitFor&quot;));</span>
<span class="fc" id="L224">        EventSet blockSet = convertToEventSet(jRWB.get(&quot;block&quot;));</span>
<span class="fc" id="L225">        EventSet interruptSet = convertToEventSet(jRWB.get(&quot;interrupt&quot;));</span>
<span class="fc" id="L226">        stmt = stmt.waitFor( waitForSet )</span>
<span class="fc" id="L227">                     .block( blockSet )</span>
<span class="fc" id="L228">                 .interrupt( interruptSet )</span>
<span class="fc" id="L229">                      .data( data );</span>
       
<span class="nc" id="L231">        captureBThreadState(stmt);</span>
<span class="nc" id="L232">    }</span>

    private EventSet convertToEventSet( Object jsObject ) {
<span class="fc bfc" id="L235" title="All 2 branches covered.">        if ( jsObject == null ) return EventSets.none;</span>
        
        // This covers event sets AND events.
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if ( jsObject instanceof EventSet ) {</span>
<span class="fc" id="L239">            return (EventSet)jsObject;</span>
        
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        } else if ( jsObject instanceof NativeArray ) {</span>
<span class="fc" id="L242">            NativeArray arr = (NativeArray) jsObject;</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">            if ( arr.isEmpty() ) return EventSets.none;</span>
            
<span class="pc bpc" id="L245" title="2 of 4 branches missed.">            if ( Stream.of(arr.getIds()).anyMatch( id -&gt; arr.get(id)==null) ) {</span>
<span class="nc" id="L246">                throw new RuntimeException(&quot;EventSet Array contains null sets.&quot;);</span>
            }
            
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">            if ( arr.getLength() == 1 ) return (EventSet)arr.get(0);</span>
            
<span class="fc" id="L251">            return ComposableEventSet.anyOf(</span>
<span class="fc" id="L252">                arr.getIndexIds().stream()</span>
<span class="fc" id="L253">                    .map( i -&gt;(EventSet)arr.get(i) )</span>
<span class="fc" id="L254">                    .collect( toSet() ) );</span>
        } else {
<span class="nc" id="L256">            final String errorMessage = &quot;Cannot convert &quot; + jsObject + &quot; of class &quot; + jsObject.getClass() + &quot; to an event set&quot;;</span>
<span class="nc" id="L257">            Logger.getLogger(BThreadSyncSnapshot.class.getName()).log(Level.SEVERE, errorMessage);</span>
<span class="nc" id="L258">            throw new IllegalArgumentException( errorMessage);</span>
        }
    }
    
    private void captureBThreadState(SyncStatement stmt) throws ContinuationPending {
<span class="fc" id="L263">        ContinuationPending capturedContinuation = Context.getCurrentContext().captureContinuation();</span>
<span class="fc" id="L264">        capturedContinuation.setApplicationState(stmt);</span>
<span class="fc" id="L265">        throw capturedContinuation;</span>
    }
    
    // /sync
    /////////////////////////
    
    
    /**
     * Push a new event to the external event queue. 
     * @param evt The event to be pushed.
     * @return the event being pushed.
     */
    public BEvent enqueueExternalEvent( BEvent evt )  {
<span class="nc" id="L278">        program.enqueueExternalEvent(evt);</span>
<span class="nc" id="L279">        return evt;</span>
    }
    
    /**
     * Sets whether the BProgram will wait for external events when there's
     * no internal event to choose.
     * 
     * @param newDaemonMode {@code true} for making {@code this} a daemon; 
     *                      {@code false} otherwise.
     */
    public void setWaitForExternalEvents( boolean newDaemonMode ) {
<span class="nc" id="L290">        program.setWaitForExternalEvents( newDaemonMode );</span>
<span class="nc" id="L291">    }</span>
    
    public boolean isWaitForExternalEvents() {
<span class="nc" id="L294">        return program.isWaitForExternalEvents();</span>
    }
    
    /**
     * @return Returns the current time in milliseconds since 1/1/1970.
     */
    public long getTime() {
<span class="nc" id="L301">        return System.currentTimeMillis();</span>
    }
    
    
    public BThreadDataProxy getThread(){
<span class="nc" id="L306">        return new BThreadDataProxy(CURRENT_BTHREAD.get());</span>
    }
    
    /**
     * Gets the name of the Java thread executing this b-thread at the moment. Useful for
     * debugging Java runtime issues.
     * 
     * @return the name of the Java thread executing this b-thread at the moment.
     */
    public String getJavaThreadName() {
<span class="nc" id="L316">        return Thread.currentThread().getName();</span>
    }
    
    @Override
    public int hashCode() {
<span class="nc" id="L321">        int hash = 7;</span>
<span class="nc" id="L322">        hash = 59 * hash + Objects.hashCode(this.program);</span>
<span class="nc" id="L323">        return hash;</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L329">            return true;</span>
        }
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (obj == null) {</span>
<span class="nc" id="L332">            return false;</span>
        }
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L335">            return false;</span>
        }
<span class="nc" id="L337">        final BProgramJsProxy other = (BProgramJsProxy) obj;</span>
<span class="nc" id="L338">        return Objects.equals(this.program, other.program);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>