<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BThreadSyncSnapshot.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bp-ide-bpjs-bp-framework</a> &gt; <a href="index.source.html" class="el_package">il.ac.bgu.cs.bp.bpjs.model</a> &gt; <span class="el_source">BThreadSyncSnapshot.java</span></div><h1>BThreadSyncSnapshot.java</h1><pre class="source lang-java linenums">package il.ac.bgu.cs.bp.bpjs.model;

import il.ac.bgu.cs.bp.bpjs.model.internal.ContinuationProgramState;
import java.io.Serializable;
import java.util.Optional;

import org.mozilla.javascript.Function;
import org.mozilla.javascript.NativeContinuation;
import org.mozilla.javascript.Scriptable;

import java.util.Objects;

/**
 * The state of a BThread at {@code bsync}.
 *
 * @author orelmosheweinstock
 * @author Michael
 */
public class BThreadSyncSnapshot implements Serializable {

    /**
     * Name of the BThread described
     */
    private String name;

    /**
     * The JavaScript function that will be called when {@code this} BThread
     * runs.
     */
    private final Function entryPoint;

    /**
     * BThreads may specify a function that runs when they are removed because
     * of a {@code breakUpon} statement.
     */
<span class="fc" id="L36">    private Function interruptHandler = null;</span>

    /**
     * Continuation of the code.
     */
    private NativeContinuation continuation;

    /**
     * BSync statement of the BThread at the time of the snapshot.
     */
    private SyncStatement syncStatement;
    
    /**
     * BThread-global data object. Can be anything. For verification, needs
     * to be serializable, and with proper {@code equals} and {@code hashCode}.
     */
    private Object data;
    
    private transient ContinuationProgramState programState;

    /**
     * Fully detailed constructor. Mostly useful for getting objects out of
     * serialized forms.
     *
     * @param name              name of the b-thread
     * @param entryPoint        function where the b-thread starts
     * @param interruptHandler  function to handle interrupts (or {@code null}, mostly)
     * @param continuation      captured b-thread continuation
     * @param bSyncStatement    current statement of the b-thread
     * @param someData          data for the b-thread (mqy be null).
     */
    public BThreadSyncSnapshot(String name, Function entryPoint, Function interruptHandler,
<span class="fc" id="L68">            Object continuation, SyncStatement bSyncStatement, Object someData) {</span>
<span class="fc" id="L69">        this.name = name;</span>
<span class="fc" id="L70">        this.entryPoint = entryPoint;</span>
<span class="fc" id="L71">        this.interruptHandler = interruptHandler;</span>
<span class="fc" id="L72">        this.continuation = (NativeContinuation)continuation;</span>
<span class="fc" id="L73">        this.syncStatement = bSyncStatement;</span>
<span class="fc" id="L74">        data = someData;</span>
<span class="fc" id="L75">    }</span>

    public BThreadSyncSnapshot(String name, Function entryPoint, Function interruptHandler,
            Object continuation, SyncStatement bSyncStatement) {
<span class="nc" id="L79">        this(name, entryPoint, interruptHandler, continuation, bSyncStatement, null);</span>
<span class="nc" id="L80">    }</span>
    
    
    public BThreadSyncSnapshot(String aName, Function anEntryPoint) {
<span class="fc" id="L84">        this(aName, anEntryPoint, null, null, null, null );</span>
<span class="fc" id="L85">    }</span>
    
    public BThreadSyncSnapshot(String aName, Object someData, Function anEntryPoint) {
<span class="nc" id="L88">        this(aName, anEntryPoint, null, null, null, someData );</span>
<span class="nc" id="L89">    }</span>

    /**
     * Creates the next snapshot of the BThread in a given run.
     *
     * @param aContinuation The BThread's continuation for the next sync.
     * @param aStatement The BThread's statement for the next sync.
     * @return a copy of {@code this} with updated continuation and statement.
     */
    public BThreadSyncSnapshot copyWith(Object aContinuation, SyncStatement aStatement) {
<span class="fc" id="L99">        BThreadSyncSnapshot retVal = new BThreadSyncSnapshot(name, entryPoint, interruptHandler, aContinuation, aStatement, data);</span>
        
<span class="fc" id="L101">        aStatement.setBthread(retVal);</span>

<span class="fc" id="L103">        return retVal;</span>
    }

    public SyncStatement getSyncStatement() {
<span class="fc" id="L107">        return syncStatement;</span>
    }

    public void setSyncStatement(SyncStatement stmt) {
<span class="fc" id="L111">        syncStatement = stmt;</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if (syncStatement.getBthread() != this) {</span>
<span class="fc" id="L113">            syncStatement.setBthread(this);</span>
        }
<span class="fc" id="L115">    }</span>

    public Object getContinuation() {
<span class="fc" id="L118">        return continuation;</span>
    }

    public String getName() {
<span class="fc" id="L122">        return name;</span>
    }

    public void setName(String name) {
<span class="nc" id="L126">        this.name = name;</span>
<span class="nc" id="L127">    }</span>

    public Optional&lt;Function&gt; getInterrupt() {
<span class="fc" id="L130">        return Optional.ofNullable(interruptHandler);</span>
    }

    public void setInterruptHandler(Function anInterruptHandler) {
<span class="nc" id="L134">        interruptHandler = anInterruptHandler;</span>
<span class="nc" id="L135">    }</span>

    public Scriptable getScope() {
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        return (continuation!=null) ? continuation : entryPoint;</span>
    }

    public Function getEntryPoint() {
<span class="fc" id="L142">        return entryPoint;</span>
    }

    public Object getData() {
<span class="fc" id="L146">        return data;</span>
    }

    public void setData(Object data) {
<span class="nc" id="L150">        this.data = data;</span>
<span class="nc" id="L151">    }</span>
    
    public ContinuationProgramState getContinuationProgramState() {
<span class="fc bfc" id="L154" title="All 2 branches covered.">        if ( programState == null ) {</span>
<span class="fc" id="L155">            programState = new ContinuationProgramState(continuation);</span>
        }
<span class="fc" id="L157">        return programState;</span>
    }
    
    @Override
    public int hashCode() {
<span class="fc" id="L162">        final int prime = 31;</span>
<span class="fc" id="L163">        int result = prime * Objects.hash(name, syncStatement);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (continuation != null) {</span>
<span class="fc" id="L165">            result += getContinuationProgramState().hashCode(name);</span>
        }
<span class="fc" id="L167">        return result;</span>
    }

    @Override
    public boolean equals(Object obj) {

        // Quick circuit-breakers
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L175">            return true;</span>
        }
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (obj == null) {</span>
<span class="nc" id="L178">            return false;</span>
        }
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (!(obj instanceof BThreadSyncSnapshot)) {</span>
<span class="nc" id="L181">            return false;</span>
        }
<span class="fc" id="L183">        BThreadSyncSnapshot other = (BThreadSyncSnapshot) obj;</span>
        
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (!Objects.equals(getName(), other.getName())) {</span>
<span class="nc" id="L186">            return false;</span>
        }
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if ( ! Objects.equals(syncStatement,other.getSyncStatement()) ) {</span>
<span class="nc" id="L189">            return false;</span>
        }
        
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if ( ! Objects.equals(data,other.getData()) ) {</span>
<span class="nc" id="L193">            return false;</span>
        }
        
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (continuation == null) {</span>
            // This b-thread hasn't run yet. Check eqality on its source.
<span class="pc bpc" id="L198" title="2 of 4 branches missed.">            return (other.continuation == null) &amp;&amp; entryPoint.equals(other.entryPoint);</span>
        } else {
            // Check equality on the PC+stack+heap
<span class="fc" id="L201">            return getContinuationProgramState().equals(other.getContinuationProgramState());</span>
        }
    }

    @Override
    public String toString() {
<span class="nc" id="L207">        return &quot;[BThreadSyncSnapshot: &quot; + name + &quot; @&quot; + hashCode() + &quot;]&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>