<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DebuggerEngineImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bp-ide-bpjs-debugger</a> &gt; <a href="index.source.html" class="el_package">il.ac.bgu.se.bp.debugger.engine</a> &gt; <span class="el_source">DebuggerEngineImpl.java</span></div><h1>DebuggerEngineImpl.java</h1><pre class="source lang-java linenums">package il.ac.bgu.se.bp.debugger.engine;

import il.ac.bgu.cs.bp.bpjs.model.BProgramSyncSnapshot;
import il.ac.bgu.se.bp.debugger.commands.DebuggerCommand;
import il.ac.bgu.se.bp.debugger.state.BPDebuggerState;
import il.ac.bgu.se.bp.execution.RunnerState;
import il.ac.bgu.se.bp.logger.Logger;
import il.ac.bgu.se.bp.utils.DebuggerStateHelper;
import il.ac.bgu.se.bp.utils.Pair;
import org.mozilla.javascript.*;
import org.mozilla.javascript.tools.debugger.Dim;

import java.util.*;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.BlockingQueue;
import java.util.function.Function;
import java.util.stream.Collectors;

public class DebuggerEngineImpl implements DebuggerEngine&lt;BProgramSyncSnapshot&gt; {
<span class="fc" id="L20">    private final Logger logger = new Logger(DebuggerEngineImpl.class);</span>
    private Dim dim;
    private final BlockingQueue&lt;DebuggerCommand&gt; queue;
    private final String filename;
<span class="fc" id="L24">    private Dim.ContextData lastContextData = null;</span>
    private volatile boolean isRunning;
    private final RunnerState state;
<span class="fc" id="L27">    private volatile boolean areBreakpointsMuted = false;</span>
<span class="fc" id="L28">    private BProgramSyncSnapshot syncSnapshot = null;</span>
    private final Function&lt;BPDebuggerState, Void&gt; onStateChangedEvent;
    private DebuggerStateHelper debuggerStateHelper;

<span class="fc" id="L32">    public DebuggerEngineImpl(String filename, RunnerState state, Function&lt;BPDebuggerState, Void&gt; onStateChangedEvent, DebuggerStateHelper debuggerStateHelper) {</span>
<span class="fc" id="L33">        this.onStateChangedEvent = onStateChangedEvent;</span>
<span class="fc" id="L34">        this.filename = filename;</span>
<span class="fc" id="L35">        this.state = state;</span>
<span class="fc" id="L36">        this.debuggerStateHelper = debuggerStateHelper;</span>
<span class="fc" id="L37">        queue = new ArrayBlockingQueue&lt;&gt;(1);</span>
<span class="fc" id="L38">        dim = new Dim();</span>
<span class="fc" id="L39">        dim.setGuiCallback(this);</span>
<span class="fc" id="L40">        dim.attachTo(ContextFactory.getGlobal());</span>
<span class="fc" id="L41">        setIsRunning(true);</span>
<span class="fc" id="L42">    }</span>

    public void setupBreakpoints(Map&lt;Integer, Boolean&gt; breakpoints) {
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if (breakpoints == null)</span>
<span class="nc" id="L46">            return;</span>
<span class="nc" id="L47">        breakpoints.forEach(this::setBreakpoint);</span>
<span class="nc" id="L48">    }</span>

    @Override
    public void updateSourceText(Dim.SourceInfo sourceInfo) {
<span class="fc" id="L52">    }</span>

    @Override
    public void enterInterrupt(Dim.StackFrame stackFrame, String s, String s1) {
<span class="nc" id="L56">        System.out.println(&quot;Breakpoint reached- &quot; + s + &quot; Line no: &quot; + stackFrame.getLineNumber());</span>
<span class="nc" id="L57">        state.setDebuggerState(RunnerState.State.JS_DEBUG);</span>
<span class="nc" id="L58">        lastContextData = stackFrame.contextData();</span>
<span class="nc" id="L59">        logger.debug(&quot;Get state from enterInterrupt&quot;);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (areBreakpointsMuted) {</span>
<span class="nc" id="L61">            continueRun();</span>
        } else {
<span class="nc" id="L63">            onStateChanged();</span>
        }
<span class="nc" id="L65">    }</span>

    @Override
    public boolean isGuiEventThread() {
<span class="nc" id="L69">        return true;</span>
    }

    @Override
    public void dispatchNextGuiEvent() throws InterruptedException {
        try {
<span class="nc" id="L75">            logger.info(&quot;Getting state from dispatchNextGuiEvent&quot;);</span>
            //onStateChanged(); todo
<span class="nc" id="L77">            queue.take().applyCommand(this);</span>
<span class="nc" id="L78">        } catch (Exception e) {</span>
<span class="nc" id="L79">            logger.error(&quot;failed on dispatchNextGuiEvent&quot;, e);</span>
<span class="nc" id="L80">        }</span>
<span class="nc" id="L81">    }</span>

    @Override
    public void addCommand(DebuggerCommand command) {
<span class="nc" id="L85">        queue.add(command);</span>
<span class="nc" id="L86">    }</span>

    private synchronized boolean isRunning() {
<span class="nc" id="L89">        return isRunning;</span>
    }

    private synchronized void setIsRunning(boolean isRunning) {
<span class="fc" id="L93">        this.isRunning = isRunning;</span>
<span class="fc" id="L94">    }</span>

    private synchronized void setAreBreakpointsMuted(boolean areBreakpointsMuted) {
<span class="nc" id="L97">        this.areBreakpointsMuted = areBreakpointsMuted;</span>
<span class="nc" id="L98">    }</span>

    @Override
    public void stop() {
<span class="nc" id="L102">        dim.setReturnValue(Dim.EXIT);</span>
<span class="nc" id="L103">        dim = null;</span>
<span class="nc" id="L104">        setIsRunning(false);</span>
<span class="nc" id="L105">    }</span>

    @Override
    public void toggleMuteBreakpoints(boolean toggleBreakPointStatus) {
<span class="nc" id="L109">        setAreBreakpointsMuted(toggleBreakPointStatus);</span>
<span class="nc" id="L110">    }</span>

    @Override
    public void stepOut() {
<span class="nc" id="L114">        dim.setReturnValue(Dim.STEP_OUT);</span>
<span class="nc" id="L115">    }</span>

    @Override
    public void stepInto() {
<span class="nc" id="L119">        dim.setReturnValue(Dim.STEP_INTO);</span>
        //@todo dim.setBreakOnEnter(true); //possible bug because BP
<span class="nc" id="L121">    }</span>

    @Override
    public void stepOver() {
<span class="nc" id="L125">        dim.setReturnValue(Dim.STEP_OVER);</span>
<span class="nc" id="L126">    }</span>

    @Override
    public void continueRun() {
<span class="nc" id="L130">        this.dim.go();</span>
<span class="nc" id="L131">    }</span>

    @Override
    public boolean isBreakpointAllowed(int lineNumber) {
<span class="nc" id="L135">        Dim.SourceInfo sourceInfo = dim.sourceInfo(this.filename);</span>
<span class="nc" id="L136">        return sourceInfo.breakableLine(lineNumber);</span>
    }

    @Override
    public void setBreakpoint(int lineNumber, boolean stopOnBreakpoint) {
        try {
<span class="nc" id="L142">            Dim.SourceInfo sourceInfo = dim.sourceInfo(this.filename);</span>
<span class="nc" id="L143">            sourceInfo.breakpoint(lineNumber, stopOnBreakpoint);</span>
<span class="nc" id="L144">            System.out.println(&quot;after set breakpoint -&quot; + &quot; line &quot; + lineNumber + &quot; changed to &quot; + stopOnBreakpoint);</span>
<span class="nc" id="L145">        } catch (Exception e) {</span>
<span class="nc" id="L146">            logger.error(&quot;cannot assign breakpoint on line {0}&quot;, lineNumber);</span>
<span class="nc" id="L147">        }</span>
<span class="nc" id="L148">    }</span>

    @Override
    public void setSyncSnapshot(BProgramSyncSnapshot syncSnapshot) {
<span class="fc" id="L152">        this.syncSnapshot = syncSnapshot;</span>
<span class="fc" id="L153">    }</span>

    @Override
    public void onStateChanged() {
<span class="nc" id="L157">        onStateChangedEvent.apply(debuggerStateHelper.generateDebuggerState(syncSnapshot, state, lastContextData));</span>
<span class="nc" id="L158">    }</span>

    //todo: remove
    public void getVars() {
<span class="nc" id="L162">        StringBuilder vars = new StringBuilder();</span>
<span class="nc" id="L163">        Dim.ContextData currentContextData = dim.currentContextData();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (int i = 0; i &lt; currentContextData.frameCount(); i++) {</span>
<span class="nc" id="L165">            vars.append(&quot;Scope no: &quot;).append(i).append(&quot;\n&quot;);</span>
<span class="nc" id="L166">            Dim.StackFrame stackFrame = currentContextData.getFrame(i);</span>
<span class="nc" id="L167">            NativeCall scope = (NativeCall) stackFrame.scope();</span>
<span class="nc" id="L168">            Object[] objects = ((Scriptable) scope).getIds();</span>
<span class="nc" id="L169">            List&lt;String&gt; arguments = Arrays.stream(objects).map(Object::toString).collect(Collectors.toList()).subList(1, objects.length);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            for (String arg : arguments) {</span>
<span class="nc" id="L171">                Object res = ScriptableObject.getProperty(scope, arg);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                if (Undefined.instance != res)</span>
<span class="nc" id="L173">                    vars.append(arg).append(&quot; &quot;).append(res).append(&quot;\n&quot;);</span>
<span class="nc" id="L174">            }</span>
        }
<span class="nc" id="L176">        System.out.println(&quot;Vars: \n&quot; + vars);</span>
<span class="nc" id="L177">    }</span>

        /*
    old code just for reference
     */
    @Override
    public void getState() {
<span class="nc" id="L184">        onStateChanged();</span>
<span class="nc" id="L185">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>